import os
import json
import logging
import requests
import asyncio
import re

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from starlette.responses import StreamingResponse
from mcp.server.sse import SseServerTransport

# =========================================================
# ê¸°ë³¸ ì„¤ì •
# =========================================================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("t3xtart")

app = FastAPI()
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

FULLWIDTH_SPACE = "ã…¤"  # â˜… ì „ê° ê³µë°± í•µì‹¬

# =========================================================
# ğŸ” Kakao Token
# =========================================================
CURRENT_ACCESS_TOKEN = os.environ.get("KAKAO_TOKEN")

def refresh_kakao_token():
    global CURRENT_ACCESS_TOKEN
    url = "https://kauth.kakao.com/oauth/token"
    data = {
        "grant_type": "refresh_token",
        "client_id": os.environ.get("KAKAO_CLIENT_ID"),
        "refresh_token": os.environ.get("KAKAO_REFRESH_TOKEN"),
        "client_secret": os.environ.get("KAKAO_CLIENT_SECRET"),
    }
    try:
        res = requests.post(url, data=data, timeout=5)
        if res.status_code == 200:
            CURRENT_ACCESS_TOKEN = res.json().get("access_token")
            return True
    except Exception as e:
        logger.error(f"Kakao token refresh failed: {e}")
    return False

async def send_kakao(content: str):
    global CURRENT_ACCESS_TOKEN
    if not CURRENT_ACCESS_TOKEN:
        refresh_kakao_token()

    url = "https://kapi.kakao.com/v2/api/talk/memo/default/send"
    headers = {"Authorization": f"Bearer {CURRENT_ACCESS_TOKEN}"}
    payload = {
        "template_object": json.dumps({
            "object_type": "text",
            "text": f"ğŸ¨ t3xtart ë„ì°©!\n\n{content}",
            "link": {"web_url": "https://playmcp.kakao.com"},
        })
    }

    res = requests.post(url, headers=headers, data=payload)
    if res.status_code == 401 and refresh_kakao_token():
        headers["Authorization"] = f"Bearer {CURRENT_ACCESS_TOKEN}"
        res = requests.post(url, headers=headers, data=payload)

    return res.status_code == 200

# =========================================================
# ğŸ§  SYSTEM PROMPT
# =========================================================
SYSTEM_ART_PROMPT = """
ë„ˆëŠ” ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ ì•„í‹°ìŠ¤íŠ¸ì•¼.

ì‚¬ìš©ìì˜ ìš”êµ¬ë¥¼ ë¶„ì„í•´ì•¼ í•´.
ì•„ë˜ì˜ ì•„íŠ¸ ìŠ¤íƒ€ì¼ ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ì„œ ì‘ì—…í•˜ë©´ ë¼!
ì¶”ìƒì ì¸ ê²½ìš° ì°½ì˜ë ¥ì„ ë°œíœ˜í•  ìˆ˜ë„ ìˆì–´ì•¼ í•´.
ì‚¬ìš©ìëŠ” êµ‰ì¥íˆ ììœ ë¡­ê²Œ ë¬´ì–¸ê°€ë¥¼ ê·¸ë ¤ë‹¬ë¼ê³  í• ê±°ê±°ë“ ?
ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì•„íŠ¸ ìŠ¤íƒ€ì¼, ì‚¬ì´ì¦ˆ, ë‚´ìš©ì— ë§ê²Œ ìµœëŒ€í•œ ì–´ìš¸ë¦¬ê³  ìµœì í™”ëœ ì•„íŠ¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ ê·¸ë ¤ì¤˜!

1. ì•„íŠ¸ ìŠ¤íƒ€ì¼ ì„¤ì •
 (í¬ê²Œ 4ê°€ì§€ë¡œ ë¶„ë¥˜í• ê±°ì•¼)
  1-1. í•œ ì¤„ ì´ëª¨ì§€ ì•„íŠ¸
    1-1-1. ì‚¬ì´ì¦ˆ: í•œ ì¤„
    1-1-2. ì „ëµ:
    - ì˜ˆ: 2026ì„ í‘œí˜„í•´ì¤˜
      - ê²°ê³¼: 2ï¸âƒ£0ï¸âƒ£2ï¸âƒ£6ï¸âƒ£
    - ì˜ˆ: í’€ì†ì„± ì›ìˆ­ì´ë¥¼ í•œ ì¤„ ì´ëª¨ì§€ë¡œ í‘œí˜„í•´ì¤˜
      - ê²°ê³¼: ğŸŒ¿ğŸ’
    - ì˜ˆ: ë‚´ê°€ ê³ ê¸°ë¥¼ ì‚¬ë‘í•œë‹¤ëŠ” ê±¸ í•œ ì¤„ ì´ëª¨ì§€ë¡œ í‘œí˜„í•´ì¤˜
      - ê²°ê³¼: ğŸ§‘â¤ï¸ğŸ–
  1-2. ì—¬ëŸ¬ ì¤„ ì´ëª¨ì§€ ì•„íŠ¸
    1-2-1. ì‚¬ì´ì¦ˆ: 9 x 9 ê·¸ë¦¬ë“œë¥¼ ë””í´íŠ¸ë¡œ í•˜ë˜, ì•„íŠ¸ ì œì‘ì— ë” ì ì ˆí•œ ê·¸ë¦¬ë“œ í¬ê¸°ê°€ ìˆê±°ë‚˜ ì‚¬ìš©ìì˜ ìš”êµ¬ê°€ ìˆì„ ê²½ìš° ì¶•ì†Œ í˜¹ì€ í™•ì¥ ê°€ëŠ¥. ë°˜ë“œì‹œ ì§ì‚¬ê°í˜• í˜•íƒœ ê·¸ë¦¬ë“œë¡œ ë‚˜íƒ€ë‚˜ê²Œ í‘œí˜„
    1-2-2. ì „ëµ: ì»¬ëŸ¬ ë¸”ë¡ì„ ì ì ˆíˆ ì‚¬ìš©(ğŸŸ©ğŸŸ¨ğŸŸ§ğŸŸ¥ğŸŸ¦ğŸŸªâ¬›ï¸â¬œï¸ ë“±), ì»¨ì…‰ì— ë§ëŠ” ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©(ì˜ˆ: ë‹¬ í‘œí˜„ ì‹œ ğŸŒ•ë¡œ ë…¸ë€ìƒ‰ í‘œí˜„, ë¹„í–‰ê¸° í‘œí˜„ ì‹œ â˜ï¸ë¡œ ë°°ê²½ í‘œí˜„í•˜ëŠ” ë“± ì°½ì˜ì„± ë°œíœ˜), í”¼ì‚¬ì²´ì™€ ë°°ê²½ì„ ëª…í™•íˆ êµ¬ë¶„í•  ìˆ˜ ìˆê²Œ í‘œí˜„, í”¼ì‚¬ì²´ì˜ í˜•íƒœê°€ ëª…í™•íˆ ë“œëŸ¬ë‚˜ê²Œ í‘œí˜„(ì˜ˆ: ì†Œë‹¤ ìº” í‘œí˜„ ì‹œ ì–‡ì€ ì§ì‚¬ê°í˜•ì˜ í”¼ì‚¬ì²´ê°€ ë“œëŸ¬ë‚˜ê²Œ í‘œí˜„, ê³ ì–‘ì´ ì–¼êµ´ í‘œí˜„ ì‹œ ë™ê·¸ë€ ì–¼êµ´ ìœ„ì— ë¾°ì¡±í•œ ê·€ê°€ ë“œëŸ¬ë‚˜ê²Œ í‘œí˜„ ë“±), ê·¸ë¦¬ë“œ í¬ê¸°ê°€ ë‚®ì€ í•´ìƒë„ ì´ìŠˆë¡œ ì ì ˆíˆ í‘œí˜„í•˜ê¸° ì–´ë µë”ë¼ë„ ê°™ì€ ì´ëª¨ì§€ ë„ë°° ë° ì›í˜•ìœ¼ë¡œ ë­‰ëš±ê·¸ë¦° í”¼ì‚¬ì²´ ì œì•ˆì€ ì•ˆ ë˜ë©° ì¶”ìƒì ì¸ í‘œí˜„ì„ ê³ ë¯¼í•´ì•¼ í•¨.
    - ì˜ˆ: ë¶ˆíƒ€ëŠ” í•´íŒŒë¦¬ë¥¼ ì—¬ëŸ¬ ì¤„ ì´ëª¨ì§€ë¡œ ìœ„íŠ¸ìˆê²Œ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: íŒŒë„ë¡œ ë°”ë‹¤ ë°°ê²½ í‘œí˜„, ì°½ì˜ì ì´ê³  ê´€ë ¨ìˆëŠ” ì´ëª¨ì§€ë¡œ í•´íŒŒë¦¬ í˜•íƒœ êµ¬í˜„, ìœ„íŠ¸ìˆëŠ” í‘œí˜„ì„ ìœ„í•´ ëˆˆê³¼ ì… ìƒì„±
      - ê²°ê³¼:
ğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠ
ğŸŒŠğŸŒŠğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸŒŠ
ğŸŒŠğŸ”¥ğŸ‘ï¸ğŸ”¥ğŸ‘ï¸ğŸ”¥ğŸŒŠ
ğŸŒŠğŸ”¥ğŸ”¥ğŸ‘„ğŸ”¥ğŸ”¥ğŸŒŠ
ğŸŒŠâš¡ï¸âš¡ï¸âš¡ï¸âš¡ï¸âš¡ï¸ğŸŒŠ
ğŸŒŠâš¡ï¸ğŸŒŠâš¡ï¸ğŸŒŠâš¡ï¸ğŸŒŠ
ğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠğŸŒŠ
    - ì˜ˆ: ë¼ë©´ì„ ì—¬ëŸ¬ ì¤„ ì´ëª¨ì§€ë¡œ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: ë‹¨ìˆœí•œ "ë¼ë©´" í‘œí˜„ì´ê¸°ì— ëŒ€ë¹„ë˜ëŠ” ê²€ì •ìƒ‰ìœ¼ë¡œ ë°°ê²½ í‘œí˜„, ë¼ë©´ê³¼ ê´€ë ¨ëœ ì´ëª¨ì§€ë¡œ ê·¸ë¦‡, ë©´, ê³„ë€ ë“±ì„ ì ì ˆíˆ í‘œí˜„, ë¼ë©´ êµ­ë¬¼ì—ëŠ” ë‹¨ìˆœí•œ ë…¸ë€ìƒ‰ ì»¬ëŸ¬ë°•ìŠ¤ ì´ëª¨ì§€ ì‚¬ìš©
      - ê²°ê³¼:
â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›
â¬›â¬›ğŸœğŸœğŸœğŸœğŸœâ¬›â¬›
â¬›ğŸœğŸŸ¨ã€°ï¸ã€°ï¸ã€°ï¸ğŸŸ¨ğŸœâ¬›
â¬›ğŸœğŸ¥ğŸ¥šğŸ–ğŸ¥šğŸ¥ğŸœâ¬›
â¬›ğŸœğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸœâ¬›
â¬›â¬›ğŸœğŸœğŸœğŸœğŸœâ¬›â¬›
â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›
    - ì˜ˆ: í’€ ì†ì„ ì§€ë‚˜ê°€ëŠ” ë±€ì„ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: ë°°ê²½ì„ í’€ ì´ëª¨ì§€ë¡œ í‘œí˜„, ë±€ì˜ í˜•íƒœë¥¼ ì´ˆë¡ìƒ‰ ì»¬ëŸ¬ë°•ìŠ¤ ì´ëª¨ì§€ ì‚¬ìš©, í•´ìƒë„ê°€ ë‚®ì•„ ë±€ì˜ ì–¼êµ´ í˜•íƒœê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ í‘œí˜„ì„ ëª»í•˜ë‹ˆ ë±€ì˜ ìƒì§•ì´ë¼ í•  ìˆ˜ ìˆëŠ” í˜€ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©, ëˆˆ ì´ëª¨ì§€ë¥¼ ë°”ë¡œ ë¶™ì—¬ì„œ ê°„ë‹¨í•˜ê²Œ ë±€ì˜ ì–¼êµ´ í‘œí˜„
      - ê²°ê³¼:
ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŸ©ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŸ©ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŸ©ğŸŸ©ğŸ‘€ğŸ‘…ğŸŒ¿ğŸŒ¿
ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿ğŸŒ¿
    - ì˜ˆ: ì§€êµ¬ë¥¼ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: ì§€êµ¬ì™€ ëŒ€ë¹„ë˜ëŠ” ê²€ì •ìƒ‰ìœ¼ë¡œ ë°°ê²½ í‘œí˜„, ë°”ë‹¤ì™€ ìœ¡ì§€ë¥¼ íŒŒë€ìƒ‰ê³¼ ì´ˆë¡ìƒ‰ ì»¬ëŸ¬ë°•ìŠ¤ ì´ëª¨ì§€ë¡œ í‘œí˜„
      - ê²°ê³¼:
â¬›â¬›â¬›ğŸŸ¦ğŸŸ¦ğŸŸ¦â¬›â¬›â¬›
â¬›â¬›ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ¦â¬›â¬›
â¬›ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¦â¬›
â¬›ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ¦ğŸŸ¦ğŸŸ¦â¬›
â¬›ğŸŸ©ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ¦ğŸŸ¦â¬›
â¬›â¬›ğŸŸ¦ğŸŸ¦ğŸŸ©ğŸŸ©ğŸŸ¦â¬›â¬›
â¬›â¬›â¬›ğŸŸ¦ğŸŸ¦ğŸŸ¦â¬›â¬›â¬›
    - ì˜ˆ: 67ì„ ì—¬ëŸ¬ ì¤„ ì´ëª¨ì§€ë¡œ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: 67 ìˆ«ì í”¼ì‚¬ì²´ë¥¼ ì ì ˆíˆ í‘œì‹œí•  ìˆ˜ ìˆëŠ” ê·¸ë¦¬ë“œ ì‚¬ì´ì¦ˆ ìë™ ì„¤ì •, ì ì ˆí•œ í”¼ì‚¬ì²´ì™€ ë°°ê²½ ìƒ‰ ì„¤ì • í›„ í‘œí˜„
      - ê²°ê³¼:
â¬›â¬›ğŸŸ¥â¬›â¬›ğŸŸ¥ğŸŸ¥ğŸŸ¥â¬›
â¬›ğŸŸ¥â¬›ğŸŸ¥â¬›ğŸŸ¥â¬›ğŸŸ¥â¬›
â¬›ğŸŸ¥â¬›â¬›â¬›â¬›â¬›ğŸŸ¥â¬›
â¬›ğŸŸ¥ğŸŸ¥ğŸŸ¥â¬›â¬›â¬›ğŸŸ¥â¬›
â¬›ğŸŸ¥â¬›ğŸŸ¥â¬›â¬›â¬›ğŸŸ¥â¬›
â¬›â¬›ğŸŸ¥â¬›â¬›â¬›â¬›ğŸŸ¥â¬›
    - ì˜ˆ: ì•…ì–´ë¥¼ 14x5ë¡œ í‘œí˜„í•´ì¤˜
      - ì „ëµ ì ìš©: 14x5 ë‚´ì—ì„œ í‘œí˜„í•  ìˆ˜ ìˆëŠ” ì•…ì–´ì˜ ì¶”ìƒì  í‘œí˜„ ì œê³µ. ê²€ì •ìƒ‰ ë°°ê²½ê³¼ ë¬¼ë¡œ ìƒê°ë  ìˆ˜ ìˆëŠ” ë¬¼ ë°°ê²½ í‘œí˜„
      - ê²°ê³¼:
â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›â¬›
â¬›â¬›â¬›ğŸŸ©â¬›ğŸŸ©â¬›ğŸŸ©â¬›â¬›â¬›â¬›â¬›â¬›
â¬›ğŸŸ©ğŸŸ©ğŸ‘€ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©â¬›â¬›â¬›
â¬›â¬œï¸â¬œï¸â¬œï¸ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©â¬›
ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦
  1-3. í•œ ì¤„ íŠ¹ìˆ˜ë¬¸ì ì´ëª¨í‹°ì½˜(ì¹´ì˜¤ëª¨ì§€)
    1-3-1. ì‚¬ì´ì¦ˆ: í•œ ì¤„
    1-3-2. ì „ëµ: íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¡°í•©í•˜ì—¬ ì°½ì˜ì ì¸ ì¹´ì˜¤ëª¨ì§€ ìƒì„±
      - ì˜ˆ: íŒŒì´íŒ…ì„ ì¹´ì˜¤ëª¨ì§€ë¡œ í‘œí˜„í•´ì¤˜
        - ê²°ê³¼: (à¸‡ â€¢Ì€_â€¢Ì)à¸‡
      - ì˜ˆ: í—ë ˆë²Œë–¡ ë‹¬ë ¤ê°€ëŠ” ë‚˜ë¥¼ í•œ ì¤„ íŠ¹ìˆ˜ë¬¸ìë¡œ ë³´ì—¬ì¤˜.
        - ê²°ê³¼: (à¸‡á–)à¸§
      - ì˜ˆ: 'ìŠ¬í¼'ë¥¼ í•œ ì¤„ íŠ¹ìˆ˜ë¬¸ìë¡œ í‘œí˜„í•´ì¤˜
        - ê²°ê³¼: (ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)
      - ì˜ˆ: ë‹¤ ë˜ì ¸ë²„ë¦¬ê³  ì‹¶ë‹¤.. ë¥¼ íŠ¹ìˆ˜ë¬¸ì ì´ëª¨í‹°ì½˜ í•œ ì¤„ë¡œ í‘œí˜„í•´ì¤„ë˜?
        - ê²°ê³¼: (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»
  1-4. ì—¬ëŸ¬ ì¤„ íŠ¹ìˆ˜ë¬¸ì ì´ëª¨í‹°ì½˜(ì•„ìŠ¤í‚¤ ì•„íŠ¸)
    1-4-1. ì‚¬ì´ì¦ˆ: ì—¬ëŸ¬ ì¤„
    1-4-2. ì „ëµ: íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¡°í•©í•˜ì—¬ ì•„ìŠ¤í‚¤ ì•„íŠ¸ ìƒì„±. ì§ì„ ê³¼ ì , 6ì ì(ì˜ˆ: â šâ ’â ˆâ ®â €â ¨â â ¢â ¨ ; braille ascii art ë¼ê³ ë„ ë¶ˆë¦¬ëŠ” ê²ƒ) ë“±ì„ ë””í´íŠ¸ë¡œ ì‚¬ìš©í•˜ë©° ìƒí™©ì— ë”°ë¼ ì•½ê°„ì˜ ì´ëª¨ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ê²¸ë¹„í•  ìˆ˜ ìˆìŒ.
      - ì˜ˆ: í•˜íŠ¸ë¥¼ ë‚ ë¦¬ëŠ” ê³ ì–‘ì´ë¥¼ ì•„ìŠ¤í‚¤ ì•„íŠ¸ë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼:
Ëšâˆ§ï¼¿âˆ§  ã€€+        â€”Ì³ÍŸÍÍğŸ’—
(  â€¢â€¿â€¢ )ã¤  â€”Ì³ÍŸÍÍ ğŸ’—
(ã¤ã€€ <                â€”Ì³ÍŸÍÍğŸ’—
ï½œã€€ _ã¤      +  â€”Ì³ÍŸÍÍğŸ’—
`ã—Â´
      - ì˜ˆ: 'í‚¤ì›Œ.' ë¼ëŠ” ë§ì´ ë¶™ì–´ìˆëŠ” ë°•ìŠ¤ì— ìˆëŠ” ê³ ì–‘ì´ë¥¼ ì§ì„  ê¸°ë°˜ ì•„ìŠ¤í‚¤ ì•„íŠ¸ë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼:
____  âˆ§ âˆ§___
|ï¼¼   (Â´ï½`)    ï¼¼
|ã€€|ï¿£ï¿£ï¿£ï¿£ï¿£|
|ã€€|ï¼ í‚¤ì›Œ.  ï¼|
 ï¼¼|ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿|
      - ì˜ˆ: ì„¸ì í´ë¡œë²„ë¥¼ ì ì ê¸°ë°˜ ì•„ìŠ¤í‚¤ ì•„íŠ¸ë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼: â €â €â €â €
â €â €â €â €â €â €â €â €â¢”â¢•â¢„â¢„â †â¡„â €â €â €â €â €â €
â €â €â €â €â €â¡€â „â¢„â ‘â¡œâ¢â …â¢•â „â €â €â €â €â €â €
â €â €â €â €â â¢Œâ ªâ ¸â  â¡â †â¢‹â  â  â¡ â¡€â €â €â €â €
â €â €â €â €â €â¡¢â¡ƒâ¡‡â¡“â €â ¥â¡¡â¢Šâ¢Œâ †â â €â €â €â €
â €â €â €â €â €â ƒâ ƒâ â €â¡â ˆâ¢ªâ¢ªâ¢ªâ¡‚â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â ¨â¡€â €â â ‘â €â €â €â €â €
      - ì˜ˆ: ë³„ì„ ì ì ê¸°ë°˜ ì•„ìŠ¤í‚¤ ì•„íŠ¸ë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼:
â €â €â¢ â£¤â¡€â €â €â €â €â €â €
â €â €â£¾â ‰â »â¢¶â ¶â ›â¢»â¡‡
â¢€â£¤â ¿â €â €â €â €â¢ â¡Ÿâ 
â¢¿â£¥â£€â €â €â €â €â €â¢»â¡†
â €â ˆâ ‰â£¿â£€â£¾â Ÿâ ›â ‹â 
â €â €â €â ˜â ›â 
      - ì˜ˆ: 'ì‚¬ë‘í•´ìš”' í”Œëœì¹´ë“œë¥¼ ë“¤ê³  ìˆëŠ” í† ë¼ë¥¼ ê·¸ë ¤ì¤˜.
        - ê²°ê³¼:
 â™¡ â™¡   á•¬ á•¬   â™¡ â™¡
     â™¡ ( âŒ¯â€²-â€²âŒ¯) â™¡
â”â”â” U Uâ”â”â”“
â™¡  ì‚¬ë‘í•´ìš”  â™¡
â”—â”â”â”â”â”â”â”›
      - ì˜ˆ: 'ë¬´ì•¼í˜¸~'ë¥¼ 6ì ìë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼: â €
â €â €â¢°â ’â ’â ’â¢²â †â €â €â¢€â ¤â¢¤â¡€â €â¡´â €â €â¢€â£€â£€â£°â£€â£€â¡€â €â €â €â €â €
â €â €â£â£€â£€â£€â¡œâ €â €â¢°â ƒâ €â¢ â ‡â¢°â “â ‚â €â¢€â ”â ’â ’â ²â¡„â €â €â €â €â €â €
â ¤â ¤â ¤â£¤â ¤â ¤â ¤â „â €â£‡â €â¢€â â¢€â¡¯â ¤â €â €â ¹â ¤â¡¤â ¤â â â €â¢ â ”â¢¤â£€â †
 â €â €â¢€â¡â €â €â €â €â €â ˆâ ‰â â €â¡¸â €â €â  â ¤â ¤â ´â §â ¤â ¤â „â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
      - ì˜ˆ: 2026ì—ì„œ 3026ìœ¼ë¡œ ë°”ë€ŒëŠ” ìˆœê°„ì„ ì•„ìŠ¤í‚¤ ì•„íŠ¸ë¡œ í‘œí˜„í•´ì¤˜.
        - ê²°ê³¼: â €â €
â”â”â”›â”ƒ
â”—â”â”“â”ƒâ”â”â”â”“â”â”â”â”“â”â”â”â”“
â”â”â”›â”ƒâ”ƒâ”â”“â”ƒâ”—â”â”“â”ƒâ”ƒâ”â”â”›
â”—â”â”â”›â”ƒâ”ƒâ”ƒâ”ƒâ”â”â”›â”ƒâ”ƒâ”—â”â”“
â”â”â”â”“â”ƒâ”ƒâ”ƒâ”ƒâ”ƒâ”â”â”›â”ƒâ”â”“â”ƒ
â”—â”â”“â”ƒâ”ƒâ”—â”›â”ƒâ”ƒâ”—â”â”“â”ƒâ”—â”›â”ƒ
â”â”â”›â”ƒâ”—â”â”â”›â”—â”â”â”›â”—â”â”â”›
â”ƒâ”â”â”›

**CRITICAL OUTPUT RULE**:
1. ì‚¬ìš©ìì˜ ìš”êµ¬ë¥¼ ìµœëŒ€í•œ ë°˜ì˜í•´ì•¼ í•¨
2. í•œ ê°€ì§€ì˜ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•´ì•¼ í•¨(í•œ ì¤„ ì´ëª¨ì§€ ì•„íŠ¸, ì—¬ëŸ¬ ì¤„ ì´ëª¨ì§€ ì•„íŠ¸, í•œ ì¤„ íŠ¹ìˆ˜ë¬¸ì ì´ëª¨í‹°ì½˜(ì¹´ì˜¤ëª¨ì§€), í•œ ì¤„ íŠ¹ìˆ˜ë¬¸ì ì´ëª¨í‹°ì½˜(ì¹´ì˜¤ëª¨ì§€))
3. ë§ˆì§€ë§‰ì˜ string contentë¥¼ ìƒì„±í•´ì•¼ í•¨
"""

# =========================================================
# ğŸ§ª ì•„íŠ¸ ê²€ì¦ ë¡œì§
# =========================================================
EMOJI_RE = re.compile("[\U0001F300-\U0001FAD6\U0001F000-\U0001FFFF]")
SPECIAL_RE = re.compile(r"[â”â”“â”—â”›â”ƒâ”â•¯â•°â•®â•­â•â–‘â–ˆâ–“]+")
REPEAT_RE = re.compile(r"(.)\1{2,}")
HANGUL_RE = re.compile("[ê°€-í£]")

def looks_like_unprocessed_text(s: str) -> bool:
    lines = s.strip().splitlines()
    if len(lines) == 1:
        if not (EMOJI_RE.search(s) or SPECIAL_RE.search(s) or REPEAT_RE.search(s)):
            return True
    return False

def validate_art(user_request: str, art: str) -> bool:
    if not art.strip():
        return False
    if looks_like_unprocessed_text(art):
        return False
    return True

# =========================================================
# ğŸ¯ í•œê¸€ ëŒ€í˜• ê¸€ì”¨ ëŒ€ì‘
# =========================================================
def korean_big_text_fallback(text: str) -> str:
    padded = f"{FULLWIDTH_SPACE*2}{text}{FULLWIDTH_SPACE*2}"
    width = len(padded)
    top = "â•”" + "â•" * width + "â•—"
    mid = f"â•‘{padded}â•‘"
    bot = "â•š" + "â•" * width + "â•"

    notice = "\n".join([
        "",
        "(äºº > <,,)",
        "í•œê¸€ ì•„ìŠ¤í‚¤ì•„íŠ¸ëŠ” ì•„ì§ ì§€ì›ì´ ì•ˆ ë¼ìš”.. ë¯¸ì•ˆí•´ìš”!"
    ])

    return "\n".join([top, mid, bot]) + notice

# =========================================================
# ğŸ§¯ Fallback (ìµœì†Œ ì‚¬ìš©)
# =========================================================
def fallback_art(user_request: str) -> str:
    return (
        "â¬›â¬›â¬›â¬›â¬›â¬›â¬›\n"
        "â¬›ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨â¬›\n"
        "â¬›ğŸŸ¨â¬›â¬›â¬›ğŸŸ¨â¬›\n"
        "â¬›ğŸŸ¨â¬›â¬›â¬›ğŸŸ¨â¬›\n"
        "â¬›ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨â¬›\n"
        "â¬›â¬›â¬›â¬›â¬›â¬›â¬›\n"
        f"({user_request})"
    )

# =========================================================
# MCP SSE
# =========================================================
sse_transport = None

@app.get("/sse")
async def sse(request: Request):
    global sse_transport
    sse_transport = SseServerTransport("/messages")

    async def stream():
        async with sse_transport.connect_sse(
            request.scope, request.receive, request._send
        ):
            while True:
                await asyncio.sleep(1)

    return StreamingResponse(stream(), media_type="text/event-stream")

@app.post("/sse")
async def sse_post(request: Request):
    body = await request.json()
    method = body.get("method")
    msg_id = body.get("id")

    if method == "initialize":
        return JSONResponse({
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {
                "protocolVersion": "2024-11-05",
                "capabilities": {
                    "tools": {
                        "system_prompt": SYSTEM_ART_PROMPT
                    }
                },
                "serverInfo": {
                    "name": "t3xtart",
                    "version": "9.0-final"
                }
            }
        })

    if method == "tools/list":
        return JSONResponse({
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {
                "tools": [{
                    "name": "render_and_send",
                    "description": "Generate text/emoji/ascii art and send to Kakao",
                    "inputSchema": {
                        "type": "object",
                        "properties": {
                            "user_request": {"type": "string"},
                            "final_art_grid": {"type": "string"}
                        },
                        "required": ["user_request", "final_art_grid"]
                    }
                }]
            }
        })

    if method == "tools/call":
        args = body["params"]["arguments"]
        user_request = args["user_request"]
        art = args["final_art_grid"].strip()

        logger.info(f"ğŸ“ Request: {user_request}")
        logger.info(f"ğŸ¨ Raw Art:\n{art}")

        # í•œê¸€ ëŒ€í˜• ê¸€ì”¨ ìš”ì²­ ì²˜ë¦¬
        if HANGUL_RE.search(user_request) and any(k in user_request for k in ["í¬ê²Œ", "êµµê²Œ", "ëŒ€í˜•"]):
            art = korean_big_text_fallback(user_request.replace("ê·¸ë ¤ì¤˜", "").strip())

        elif not validate_art(user_request, art):
            art = fallback_art(user_request)

        await send_kakao(art)

        return JSONResponse({
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {
                "content": [{"type": "text", "text": "âœ… ì „ì†¡ ì™„ë£Œ"}]
            }
        })

    return JSONResponse({"jsonrpc": "2.0", "id": msg_id, "result": {}})

# =========================================================
# Health
# =========================================================
@app.get("/")
async def health():
    return "t3xtart alive"
